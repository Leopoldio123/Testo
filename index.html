<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ü–µ—á–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 16px;
            box-sizing: border-box;
        }
        h2 { margin-top: 0; font-size: 18px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-size: 14px; color: var(--tg-theme-hint-color, #888); }
        input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000);
        }
        button {
            width: 100%;
            padding: 14px;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        .result-card {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid var(--tg-theme-button-color, #3390ec);
        }
        .result-title { font-weight: bold; margin-bottom: 8px; display: block; font-size: 16px;}
        .result-line { margin-bottom: 4px; font-size: 14px; }
        pre { 
            white-space: pre-wrap; 
            font-family: monospace; 
            font-size: 12px; 
            color: var(--tg-theme-text-color);
        }
    </style>
</head>
<body>

    <h2>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—á–∏ (–º–º)</h2>
    
    <div class="input-group">
        <label>–î–ª–∏–Ω–∞ (L)</label>
        <input type="number" id="lenL" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000">
    </div>
    <div class="input-group">
        <label>–®–∏—Ä–∏–Ω–∞ (W)</label>
        <input type="number" id="widW" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3000">
    </div>
    <div class="input-group">
        <label>–í—ã—Å–æ—Ç–∞ (H)</label>
        <input type="number" id="hgtH" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2500">
    </div>

    <button onclick="calculate()">–†–ê–°–°–ß–ò–¢–ê–¢–¨</button>

    <div id="output"></div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- –õ–û–ì–ò–ö–ê –†–ê–°–ß–ï–¢–ê (–ü–µ—Ä–µ–ø–∏—Å–∞–Ω–æ —Å Python –Ω–∞ JS) ---
        const PANEL_LENGTH_MM = 6000;
        const MIN_OFFCUT_LENGTH_MM = 400;

        class NestingEngine {
            constructor(panelWidth) {
                this.panelWidth = panelWidth;
                this.panelLength = PANEL_LENGTH_MM;
                this.sheetsUsed = 0;
                this.offcuts = []; // {length, width}
                this.log = [];
            }

            findBestOffcut(reqLen, reqWidth) {
                let bestIdx = -1;
                let minWaste = Infinity;

                for (let i = 0; i < this.offcuts.length; i++) {
                    const offcut = this.offcuts[i];
                    if (offcut.length >= reqLen && offcut.width >= reqWidth) {
                        const waste = (offcut.length * offcut.width) - (reqLen * reqWidth);
                        if (waste < minWaste) {
                            minWaste = waste;
                            bestIdx = i;
                        }
                    }
                }
                return bestIdx;
            }

            getPiece(length, width, context) {
                const idx = this.findBestOffcut(length, width);

                if (idx !== -1) {
                    // –ë–µ—Ä–µ–º –æ—Å—Ç–∞—Ç–æ–∫
                    const sourcePiece = this.offcuts.splice(idx, 1)[0];
                    // this.log.push(`‚ôªÔ∏è ${context}: –í–∑—è—Ç –æ—Å—Ç–∞—Ç–æ–∫ ${sourcePiece.length}x${sourcePiece.width}`);

                    // –û—Å—Ç–∞—Ç–æ–∫ –ø–æ –¥–ª–∏–Ω–µ
                    const remLen = sourcePiece.length - length;
                    if (remLen >= MIN_OFFCUT_LENGTH_MM) {
                        this.offcuts.push({ length: remLen, width: sourcePiece.width });
                    }
                    
                    // –û—Å—Ç–∞—Ç–æ–∫ –ø–æ —à–∏—Ä–∏–Ω–µ
                    const remWidth = sourcePiece.width - width;
                    if (remWidth >= 100) {
                        this.offcuts.push({ length: length, width: remWidth });
                    }

                } else {
                    // –ù–æ–≤—ã–π –ª–∏—Å—Ç
                    this.sheetsUsed++;
                    // this.log.push(`üÜï ${context}: –ù–æ–≤—ã–π –ª–∏—Å—Ç`);

                    const remLen = this.panelLength - length;
                    if (remLen >= MIN_OFFCUT_LENGTH_MM) {
                        this.offcuts.push({ length: remLen, width: this.panelWidth });
                    }

                    const remWidth = this.panelWidth - width;
                    if (remWidth >= 100) {
                        this.offcuts.push({ length: length, width: remWidth });
                    }
                }
            }

            processSurface(name, totalLength, cutLength) {
                const fullStrips = Math.floor(totalLength / this.panelWidth);
                const lastStripWidth = totalLength % this.panelWidth;

                for (let i = 0; i < fullStrips; i++) {
                    this.getPiece(cutLength, this.panelWidth, `${name} (—Ü–µ–ª–∞—è)`);
                }

                if (lastStripWidth > 0) {
                    this.getPiece(cutLength, lastStripWidth, `${name} (–¥–æ–±–æ—Ä)`);
                }
            }
        }

        function runEngine(L, W, H, panelWidth) {
            const engine = new NestingEngine(panelWidth);
            
            // –õ–æ–≥–∏–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –∏–∑ –¢–ó:
            const floorCeilCutLen = W + 200; 
            const floorCeilCoverLen = L;
            
            // –ü–æ–ª –∏ –ü–æ—Ç–æ–ª–æ–∫
            engine.processSurface("–ü–æ–ª", floorCeilCoverLen, floorCeilCutLen);
            engine.processSurface("–ü–æ—Ç–æ–ª–æ–∫", floorCeilCoverLen, floorCeilCutLen);
            
            // –°—Ç–µ–Ω—ã (–ú–æ–Ω—Ç–∞–∂: L - –¥–ª–∏–Ω–∞ –ø–æ–∫—Ä—ã—Ç–∏—è, H - –≤—ã—Å–æ—Ç–∞ –ø–∞–Ω–µ–ª–∏/–∫—É—Å–∫–∞)
            engine.processSurface("–°—Ç–µ–Ω–∞ –õ", H, L);
            engine.processSurface("–°—Ç–µ–Ω–∞ –ü", H, L);

            // –¢–æ—Ä—Ü—ã
            engine.processSurface("–ó–∞–¥–Ω—è—è", W, H);
            engine.processSurface("–î–≤–µ—Ä–∏", W, H);

            return engine;
        }

        function formatReport(width, engine) {
            let html = `<div class="result-card">`;
            html += `<span class="result-title">üõ† –ü–∞–Ω–µ–ª–∏ ${width}–º–º</span>`;
            html += `<div class="result-line">üì¶ –õ–∏—Å—Ç–æ–≤ 6000–º–º: <b>${engine.sheetsUsed} —à—Ç</b></div>`;
            
            // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ—Å—Ç–∞—Ç–∫–æ–≤
            const counts = {};
            engine.offcuts.forEach(o => {
                const key = `${o.length}x${o.width}`;
                counts[key] = (counts[key] || 0) + 1;
            });

            let offcutsStr = "";
            for (const [size, count] of Object.entries(counts)) {
                offcutsStr += `‚Ä¢ ${size}–º–º: ${count} —à—Ç\n`;
            }
            if (!offcutsStr) offcutsStr = "–ù–µ—Ç –ø–æ–ª–µ–∑–Ω—ã—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤";

            html += `<div class="result-line">‚úÇÔ∏è –û—Å—Ç–∞—Ç–∫–∏:</div>`;
            html += `<pre>${offcutsStr}</pre>`;
            html += `</div>`;
            return html;
        }

        function calculate() {
            const L = parseInt(document.getElementById('lenL').value);
            const W = parseInt(document.getElementById('widW').value);
            const H = parseInt(document.getElementById('hgtH').value);

            if (!L || !W || !H) {
                tg.showAlert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤—Å–µ —Ä–∞–∑–º–µ—Ä—ã!");
                return;
            }

            const
