<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ü–µ—á–∏ PRO</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 16px;
            box-sizing: border-box;
        }
        h2 { margin-top: 0; font-size: 18px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-size: 14px; color: var(--tg-theme-hint-color, #888); }
        input {
            width: 100%;
            padding: 12px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000);
        }
        button {
            width: 100%;
            padding: 14px;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }
        button:active { opacity: 0.8; }
        
        .result-card {
            background: var(--tg-theme-secondary-bg-color, #f5f5f5);
            padding: 12px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid var(--tg-theme-button-color, #3390ec);
        }
        .result-title { font-weight: bold; margin-bottom: 8px; display: block; font-size: 16px;}
        .result-line { margin-bottom: 4px; font-size: 14px; }
        
        details { margin-top: 10px; }
        summary { cursor: pointer; font-size: 14px; color: var(--tg-theme-link-color, #3390ec); font-weight: bold; }
        .log-box {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 4px;
            margin-top: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            white-space: pre-wrap;
            color: var(--tg-theme-text-color);
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ */
        #debug-status { margin-top: 20px; font-size: 12px; color: green; font-weight: bold; text-align: center;}
        #global-error { 
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.95); 
            color: red; padding: 20px; z-index: 9999; overflow: scroll;
        }
    </style>
</head>
<body>

    <div id="global-error"></div>

    <h2>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Ä–∞–∑–º–µ—Ä—ã (–º–º)</h2>
    
    <div class="input-group">
        <label>–î–ª–∏–Ω–∞ (L)</label>
        <input type="number" id="lenL" placeholder="3500">
    </div>
    <div class="input-group">
        <label>–®–∏—Ä–∏–Ω–∞ (W)</label>
        <input type="number" id="widW" placeholder="1800">
    </div>
    <div class="input-group">
        <label>–í—ã—Å–æ—Ç–∞ (H)</label>
        <input type="number" id="hgtH" placeholder="2000">
    </div>

    <button onclick="handleCalculate()">–†–ê–°–°–ß–ò–¢–ê–¢–¨ –ú–ê–¢–ï–†–ò–ê–õ–´</button>

    <div id="output"></div>
    <div id="debug-status">‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>

    <script>
        // 1. –ì–õ–û–ë–ê–õ–¨–ù–´–ô –ü–ï–†–ï–•–í–ê–¢–ß–ò–ö –û–®–ò–ë–û–ö (–ü–æ–∫–∞–∂–µ—Ç –æ—à–∏–±–∫—É –Ω–∞ —ç–∫—Ä–∞–Ω–µ)
        window.onerror = function(message, source, lineno, colno, error) {
            const errorBox = document.getElementById('global-error');
            errorBox.style.display = 'block';
            errorBox.innerHTML = `
                <h3>üí• –ü–†–û–ò–ó–û–®–õ–ê –û–®–ò–ë–ö–ê</h3>
                <p><b>–°–æ–æ–±—â–µ–Ω–∏–µ:</b> ${message}</p>
                <p><b>–°—Ç—Ä–æ–∫–∞:</b> ${lineno}</p>
                <pre>${error && error.stack ? error.stack : ''}</pre>
                <button onclick="document.getElementById('global-error').style.display='none'">–ó–∞–∫—Ä—ã—Ç—å</button>
            `;
        };

        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const PANEL_LENGTH_MM = 6000;
        const MIN_OFFCUT_LENGTH_MM = 400; 

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
        let tg = window.Telegram.WebApp;
        try { tg.expand(); } catch(e) {}

        // --- –ö–õ–ê–°–° –†–ê–°–ß–ï–¢–ê ---
        class NestingEngine {
            constructor(panelWidth) {
                this.panelWidth = panelWidth;
                this.panelLength = PANEL_LENGTH_MM;
                this.sheetsUsed = 0;
                this.offcuts = []; 
                this.log = []; 
            }

            addLog(msg) {
                this.log.push(msg);
            }

            findBestOffcut(reqLen, reqWidth) {
                let bestIdx = -1;
                let minWaste = Infinity;

                for (let i = 0; i < this.offcuts.length; i++) {
                    const offcut = this.offcuts[i];
                    if (offcut.length >= reqLen && offcut.width >= reqWidth) {
                        const waste = (offcut.length * offcut.width) - (reqLen * reqWidth);
                        if (waste < minWaste) {
                            minWaste = waste;
                            bestIdx = i;
                        }
                    }
                }
                return bestIdx;
            }

            getPiece(length, width, contextName) {
                const idx = this.findBestOffcut(length, width);
                let sourceDesc = "";

                if (idx !== -1) {
                    const sourcePiece = this.offcuts.splice(idx, 1)[0];
                    sourceDesc = `‚ôªÔ∏è –í–∑—è—Ç –æ—Å—Ç–∞—Ç–æ–∫ ${sourcePiece.length}x${sourcePiece.width}`;
                    
                    const remLen = sourcePiece.length - length;
                    if (remLen >= MIN_OFFCUT_LENGTH_MM) {
                        this.offcuts.push({ length: remLen, width: sourcePiece.width });
                        sourceDesc += ` -> –ù–æ–≤—ã–π –æ—Å—Ç. ${remLen}x${sourcePiece.width}`;
                    }
                    
                    const remWidth = sourcePiece.width - width;
                    if (remWidth >= 100) {
                        this.offcuts.push({ length: length, width: remWidth });
                        sourceDesc += ` + –ü–æ–ª–æ—Å–∞ ${length}x${remWidth}`;
                    }

                } else {
                    this.sheetsUsed++;
                    sourceDesc = `üÜï –ù–æ–≤—ã–π –õ–∏—Å—Ç ‚Ññ${this.sheetsUsed}`;

                    const remLen = this.panelLength - length;
                    if (remLen >= MIN_OFFCUT_LENGTH_MM) {
                        this.offcuts.push({ length: remLen, width: this.panelWidth });
                        sourceDesc += ` -> –û—Å—Ç–∞—Ç–æ–∫ –¥–ª–∏–Ω—ã ${remLen}–º–º`;
                    }

                    const remWidth = this.panelWidth - width;
                    if (remWidth >= 100) {
                        this.offcuts.push({ length: length, width: remWidth });
                        sourceDesc += ` + –ü–æ–ª–æ—Å–∞ ${length}x${remWidth}`;
                    }
                }
                
                this.addLog(`   üî∏ ${contextName} (${length}x${width}): ${sourceDesc}`);
            }

            processSurface(name, totalCoverLength, cutLength) {
                this.addLog(`\nüî∑ –†–ê–°–ß–ï–¢: ${name.toUpperCase()}`);
                this.addLog(`   –ù—É–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å ${totalCoverLength}–º–º. –†–µ–∂–µ–º –∫—É—Å–∫–∏ –¥–ª–∏–Ω–æ–π ${cutLength}–º–º.`);

                const fullStrips = Math.floor(totalCoverLength / this.panelWidth);
                const lastStripWidth = totalCoverLength % this.panelWidth;

                for (let i = 0; i < fullStrips; i++) {
                    this.getPiece(cutLength, this.panelWidth, `${name} (—Ü–µ–ª–∞—è ${i+1})`);
                }

                if (lastStripWidth > 0) {
                    this.getPiece(cutLength, lastStripWidth, `${name} (–¥–æ–±–æ—Ä ${lastStripWidth}–º–º)`);
                }
            }
        }

        // --- –õ–û–ì–ò–ö–ê ---
        function runEngine(L, W, H, panelWidth) {
            const engine = new NestingEngine(panelWidth);
            
            // 1. –ü–æ–ª –∏ –ü–æ—Ç–æ–ª–æ–∫ (–®–∏—Ä–∏–Ω–∞ + 200)
            engine.processSurface("–ü–æ–ª", L, W + 200);
            engine.processSurface("–ü–æ—Ç–æ–ª–æ–∫", L, W + 200);
            
            // 2. –°—Ç–µ–Ω—ã (–í—ã—Å–æ—Ç–∞ H)
            engine.processSurface("–°—Ç–µ–Ω–∞ –õ–µ–≤", L, H);
            engine.processSurface("–°—Ç–µ–Ω–∞ –ü—Ä–∞–≤", L, H);

            // 3. –¢–æ—Ä—Ü—ã (–ù–û–í–û–ï –ü–†–ê–í–ò–õ–û: +200 –∫ W –∏ +200 –∫ H)
            const endCover = W + 200;
            const endCut = H + 200;
            
            engine.processSurface("–ó–∞–¥–Ω—è—è —Å—Ç–µ–Ω–∫–∞", endCover, endCut);
            engine.processSurface("–î–≤–µ—Ä–∏", endCover, endCut);

            return engine;
        }

        function formatReport(width, engine) {
            let html = '<div class="result-card">';
            
            html += '<span class="result-title">üõ† –ü–∞–Ω–µ–ª–∏ ' + width + '–º–º</span>';
            html += '<div class="result-line">üì¶ –í–°–ï–ì–û –õ–ò–°–¢–û–í: <b>' + engine.sheetsUsed + ' —à—Ç</b></div>';
            
            const counts = {};
            engine.offcuts.forEach(o => {
                const key = o.length + 'x' + o.width;
                counts[key] = (counts[key] || 0) + 1;
            });
            let offcutsStr = "";
            for (const [size, count] of Object.entries(counts)) {
                offcutsStr += '‚Ä¢ ' + size + '–º–º: ' + count + ' —à—Ç\n';
            }
            if (!offcutsStr) offcutsStr = "–ù–µ—Ç";
            html += '<div class="result-line">‚úÇÔ∏è –ü–æ–ª–µ–∑–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏:\n' + offcutsStr + '</div>';

            html += '<details>';
            html += '<summary>üìú –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ö–µ–º—É —Ä–∞—Å–∫—Ä–æ—è</summary>';
            html += '<div class="log-box">' + engine.log.join('\n') + '</div>';
            html += '</details>';
            
            html += '</div>';
            return html;
        }

        // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö ---
        function handleCalculate() {
            const output = document.getElementById('output');
            output.innerHTML = "–°—á–∏—Ç–∞—é..."; 
            
            // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —á–∏—Ç–∞–µ–º –∫–∞–∫ —á–∏—Å–ª–∞
            const L = parseInt(document.getElementById('lenL').value);
            const W = parseInt(document.getElementById('widW').value);
            const H = parseInt(document.getElementById('hgtH').value);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ NaN
            if (isNaN(L) || isNaN(W) || isNaN(H)) {
                output.innerHTML = '<div class="error-msg">–û—à–∏–±–∫–∞: –í–≤–µ–¥–∏—Ç–µ –≤—Å–µ —Ü–∏—Ñ—Ä—ã!</div>';
                return;
            }

            output.innerHTML = ""; 

            // 1000–º–º
            const engine1000 = runEngine(L, W, H, 1000);
            output.innerHTML += formatReport(1000, engine1000);

            // 1190–º–º
            const engine1190 = runEngine(L, W, H, 1190);
            output.innerHTML += formatReport(1190, engine1190);
            
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
        }

        // –°–ò–ì–ù–ê–õ, –ß–¢–û –°–ö–†–ò–ü–¢ –ó–ê–ì–†–£–ó–ò–õ–°–Ø
        document.getElementById('debug-status').innerHTML = "üü¢ –°–ò–°–¢–ï–ú–ê –ì–û–¢–û–í–ê";
        
    </script>
</body>
</html>
